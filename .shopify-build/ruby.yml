containers:
  trusty:
    docker: ubuntu:14.04
  xenial:
    docker: ubuntu:16.04
  packagecloud:
    docker: gcr.io/shopify-docker-images/ci/packagecloud:0.1

shared:
  package_builder: &package_builder
    timeout: 15m
    init:
    - apt-get update
    run:
    - apt-get install -y devscripts git openssh-client ruby equivs
    - ./bin/ci/build.sh
    artifact_paths:
    - artifacts
  publish: &publish
    timeout: 5m
    container: packagecloud
    run:
    - ls -l debs
    - publish_debs debs ${DIST}
    import_artifacts:
    - pattern: '*.deb'
      into: debs
      job_id: Build ${DIST} debs

steps:
- <<: *package_builder
  label: Build trusty debs
  container: trusty
  init:
  - apt-get update
  - apt-get install -y ruby2.0
  - update-alternatives --install /usr/bin/ruby ruby2.0 /usr/bin/ruby2.0 10
- <<: *package_builder
  label: Build xenial debs
  container: xenial
- label: Build source tarball for buildpacks # similar to https://github.com/hone/docker-heroku-ruby-builder/blob/master/build.rb
  container: trusty # to build for cedar, see https://github.com/heroku/heroku-buildpack-ruby/blob/f16fbb6cdd08b52af1149140b14619c5f14262c7/lib/language_pack/base.rb#L20
  timeout: 15m
  run:
  - apt-get update
  - apt-get install -y git openssh-client
  - apt-get install -y autoconf bison build-essential equivs devscripts libreadline-dev libssl-dev libyaml-dev zlib1g-dev libffi-dev libgdbm3 libgdbm-dev # lifted from debian control file
  - apt-get install -y systemtap-sdt-dev # needed for --enable-dtrace to work, which is (currently) the main point of doing this build
  - apt-get install -y ruby2.0
  - update-alternatives --install /usr/bin/ruby ruby2.0 /usr/bin/ruby2.0 10
  - git clone git@github.com:shopify/ruby.git
  - cd ruby
  - git fetch --tags
  - git checkout v2_5_1
  - autoconf
  - mkdir -p /tmp/rubybuild /artifacts
  - ./configure --enable-dtrace debugflags="-g3 -ggdb" --prefix=/tmp/rubybuild
  - make -j$(nproc)
  - make install
  - cd /tmp/rubybuild
  - tar -czf /artifacts/ruby-2.5.1.tar.gz *
  artifact_paths:
  - /artifacts

- block: "Publish debs"

- <<: *publish
  label: Publish trusty debs
  env:
    DIST: trusty
- <<: *publish
  label: Publish xenial debs
  env:
    DIST: xenial
